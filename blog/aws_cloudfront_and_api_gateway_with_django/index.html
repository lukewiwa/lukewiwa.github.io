<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AWS cloudfront and API Gateway with Django</title><link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.min.css"><link rel="stylesheet" href="/index.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark.min.css" media="screen and (prefers-color-scheme: dark)"></head><body><header><nav class="flex flex-row items-center justify-between"><a href="/" class="link nav-brand no-underline dtc w-25 f3">Wiwa</a><div class="dtc v-mid w-75 tr"><a href="/blog" class="link nav-link f6 f5-ns dib mr3 mr4-ns b">Blog</a><a href="/projects" class="link nav-link f6 f5-ns dib mr3 mr4-ns ">Projects</a></div></nav></header><main class="pt-4"><article><h1 class="f2">AWS cloudfront and API Gateway with Django</h1><time class="db mb1 gray">2025-02-19</time><div><p>If you are hosting a web app on AWS you should be putting a Cloudfront instance in front of it. There are a few advantages but at the end of the day it's cheaper, allows for global caching at the edge and provides a fairly straight forward way to obtain SSL certificates. In my own hosting of apps I will more often than not use API gateway in front of Django too as this gives you some nice tools such as rate limiting and whatnot. But it seems really annoying and difficult to get it all working with a Django app given Django's security model around the allowed hosts.</p>
<!--more-->
<p>I had a few goes at this and thought it might be fairly straight forward but it turns out AWS needs it's own host headers for integration purposes if you are using cloudfront and API Gateway. As such we need to do a little bit of faff to get the host header over to Django.</p>
<p>Firstly on the application side we need to tell Django to use the <code>x-forwarded-host</code> header for host checks in the <code>ALLOWED_HOSTS</code> setting. This is necessary if we are integrating into API Gateway or Lambda URLs since the host header is expected to be the domain of the cloudfront distribution.</p>
<pre><code class="language-python hljs">ALLOWED_HOSTS = [<span class="hljs-string">"yourdomain.com"</span>]
USE_X_FORWARDED_HOST = <span class="hljs-literal">True</span>
</code></pre>
<p>Secondly we need to actually forward the host through using the <code>x-forwarded-host</code> header. Cloudfront has no native setting to do this for us so we need to use a cloudfront function. It's not particularly complicated but does introduce another resource to manage.</p>
<pre><code class="language-javascript hljs"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-keyword">const</span> request = event.<span class="hljs-property">request</span>;
  request.<span class="hljs-property">headers</span>[<span class="hljs-string">"x-forwarded-host"</span>] = { <span class="hljs-attr">value</span>: request.<span class="hljs-property">headers</span>.<span class="hljs-property">host</span>.<span class="hljs-property">value</span> };
  <span class="hljs-keyword">return</span> request;
}
</code></pre>
<p>Thirdly we need to connect to our integration. Below is a CDK representation of what that would look like. It's important to note that there are a number of native <a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_cloudfront_origins-readme.html">cloudfront CDK integrations</a> in to various AWS services. In my particular case I'm using API Gateway HTTP Endpoints which are somewhat simpler than the old REST Endpoints but you do have to do a little bit of work yourself.</p>
<pre><code class="language-typescript hljs"><span class="hljs-keyword">const</span> forwardHostHeader = <span class="hljs-keyword">new</span> cloudfront.<span class="hljs-title class_">Function</span>(
  <span class="hljs-variable language_">this</span>,
  <span class="hljs-string">"ForwardHeaderCfFunction"</span>,
  {
    <span class="hljs-attr">code</span>: cloudfront.<span class="hljs-property">FunctionCode</span>.<span class="hljs-title function_">fromFile</span>({
      <span class="hljs-comment">// Filename of the above cloudfront function code</span>
      <span class="hljs-attr">filePath</span>: <span class="hljs-string">"./lib/forwardHostFunction.js"</span>,
    }),
    <span class="hljs-attr">runtime</span>: cloudfront.<span class="hljs-property">FunctionRuntime</span>.<span class="hljs-property">JS_2_0</span>,
  }
);

<span class="hljs-keyword">const</span> cachePolicy = <span class="hljs-keyword">new</span> cloudfront.<span class="hljs-title class_">CachePolicy</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">"CachePolicy"</span>, {
  <span class="hljs-attr">cookieBehavior</span>: cloudfront.<span class="hljs-property">CacheCookieBehavior</span>.<span class="hljs-title function_">all</span>(),
  <span class="hljs-attr">queryStringBehavior</span>: cloudfront.<span class="hljs-property">CacheQueryStringBehavior</span>.<span class="hljs-title function_">all</span>(),
});

<span class="hljs-keyword">const</span> distribution = <span class="hljs-keyword">new</span> cloudfront.<span class="hljs-title class_">Distribution</span>(
  <span class="hljs-variable language_">this</span>,
  <span class="hljs-string">"CloudfrontDistribution"</span>,
  {
    <span class="hljs-attr">domainNames</span>: [<span class="hljs-string">"your-domain-name.com"</span>],
    <span class="hljs-attr">defaultBehavior</span>: {
      <span class="hljs-comment">// This could be a load balancer or an API gateway</span>
      <span class="hljs-comment">// or any number of AWS services.</span>
      <span class="hljs-attr">origin</span>: <span class="hljs-keyword">new</span> origins.<span class="hljs-title class_">HttpOrigin</span>(
        <span class="hljs-string">`internalAWSdomain.com`</span>
      ),
      <span class="hljs-attr">functionAssociations</span>: [
        {
          <span class="hljs-attr">function</span>: forwardHostHeader,
          <span class="hljs-attr">eventType</span>: cloudfront.<span class="hljs-property">FunctionEventType</span>.<span class="hljs-property">VIEWER_REQUEST</span>,
        }
      ]
      cachePolicy,
      <span class="hljs-attr">originRequestPolicy</span>:
        cloudfront.<span class="hljs-property">OriginRequestPolicy</span>.<span class="hljs-property">ALL_VIEWER_EXCEPT_HOST_HEADER</span>,
      <span class="hljs-attr">allowedMethods</span>: cloudfront.<span class="hljs-property">AllowedMethods</span>.<span class="hljs-property">ALLOW_ALL</span>,
      <span class="hljs-attr">viewerProtocolPolicy</span>:
        cloudfront.<span class="hljs-property">ViewerProtocolPolicy</span>.<span class="hljs-property">REDIRECT_TO_HTTPS</span>,
    },
  }
);
</code></pre>
<p>In terms of the cloudfront distribution itself there are some extra configurations that we need to add on the defaults to make our Django application work as expected.</p>
<ul>
<li>We need to allow all http methods. By default cloudfront only allows GET and OPTIONS, any writable http requests need to be explicitly allowed.</li>
<li>We need to be aware of the caching strategy. By default the AWS predefined CACHE OPTIMIZED strategy doesn't take into account cookies or query strings. In your typical django project we'll need both included to address user accounts and list views among other things.</li>
<li>We need to avoid forwarding the original host header through to API Gateway. This will break integrations and basically get a permission denied error so we use the <code>ALL_VIEWER_EXCEPT_HOST_HEADER</code> managed policy.</li>
</ul>
<p>With all this in place the host header should flow from cloudfront all the way through to our application using the <code>x-forwarded-host</code> header and we should be able to set the <code>ALLOWED_HOSTS</code> Django setting to our original URL.</p>
<p>Annoyingly I feel like none of this is particularly clear in the AWS docs, the only reference I could find to it was in the <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-managed-origin-request-policies.html#managed-origin-request-policy-all-viewer-except-host-header">managed origin request policies page</a> which calls out specifically API Gateway and Lambda function URLs as requiring this header.</p>
</div></article></main></body></html>