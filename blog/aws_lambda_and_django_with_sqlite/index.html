<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AWS Lambda and Django With Sqlite</title><link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.min.css"><link rel="stylesheet" href="/index.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark.min.css" media="screen and (prefers-color-scheme: dark)"></head><body><header><nav class="flex flex-row items-center justify-between"><a href="/" class="link nav-brand no-underline dtc w-25 f3">Wiwa</a><div class="dtc v-mid w-75 tr"><a href="/blog" class="link nav-link f6 f5-ns dib mr3 mr4-ns b">Blog</a><a href="/projects" class="link nav-link f6 f5-ns dib mr3 mr4-ns ">Projects</a></div></nav></header><main class="pt-4"><article><h1 class="f2">AWS Lambda and Django With Sqlite</h1><time class="db mb1">2022-10-20</time><div><p>Running Django on AWS Lambda has become fairly mainstream and there are many tools to assist with this goal. There is however a pain point which is admittedly not a conventional use case but a possible use case none the less. Django supports a version of sqlite that is above the current version supported on the underlying operating systems of the AWS python lambda implementation. If you're interested lambda functions run on Amazon Linux 1 and 2 which are based on CentOS 6 and 7 respectively.</p>
<!--more-->
<p>There are a few ways to get around this, all of them involving either building the source yourself or standing on the shoulders of <a href="https://github.com/FlipperPA/django-s3-sqlite/">other people who already have</a>. Some people have created <a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html">lambda layers</a> to add the required libraries.</p>
<p>With lambda now supporting container images I thought an easy thing to do would be to precompile sqlite inside the image using the build process in the <a href="https://github.com/coleifer/pysqlite3">pysqlite3</a> repository. This repo formalises a build process for creating more up to date <code>sqlite3</code> python modules. Using the magic of <a href="https://docs.docker.com/develop/develop-images/multistage-build/">multi-stage builds</a> we can build everything and only copy over the relevant output files. The final image won't even have the build tools which cuts down on image size. Here's an example:</p>
<pre><code class="language-dockerfile hljs"><span class="hljs-keyword">ARG</span> PYTHON_VERSION=<span class="hljs-number">3.9</span>
<span class="hljs-keyword">FROM</span> public.ecr.aws/lambda/python:${PYTHON_VERSION} as build

<span class="hljs-keyword">RUN</span><span class="language-bash"> yum groupinstall -y <span class="hljs-string">"Development Tools"</span> &amp;&amp; \
    yum install -y tcl</span>

<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> git <span class="hljs-built_in">clone</span> --depth 1 --branch master https://github.com/coleifer/pysqlite3.git</span>

<span class="hljs-keyword">RUN</span><span class="language-bash"> curl -sSL https://www.sqlite.org/src/tarball/sqlite.tar.gz?r=release \
    --output sqlite.tar.gz</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> tar xzf sqlite.tar.gz</span>
<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /sqlite</span>
<span class="hljs-keyword">RUN</span><span class="language-bash">  ./configure &amp;&amp; make sqlite3.c</span>

<span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cp</span> /sqlite/sqlite3.[ch] /pysqlite3/</span>
<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /pysqlite3</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> python setup.py build_static build</span>


<span class="hljs-keyword">FROM</span> public.ecr.aws/lambda/python:${PYTHON_VERSION}
<span class="hljs-keyword">ARG</span> PYTHON_VERSION

<span class="hljs-keyword">COPY</span><span class="language-bash"> --from=build /pysqlite3/build/lib.linux-*/pysqlite3/_sqlite3.*.so /var/lang/lib/python<span class="hljs-variable">${PYTHON_VERSION}</span>/lib-dynload/</span>
</code></pre>
<p>You can see the source at <a href="https://github.com/lukewiwa/aws-lambda-python-sqlite">github</a> and pull the final product from <a href="https://hub.docker.com/r/lukewiwa/aws-lambda-python-sqlite">dockerhub</a>. I've set up monthly builds so hopefully things keep up to date for a while.</p>
</div></article></main></body></html>