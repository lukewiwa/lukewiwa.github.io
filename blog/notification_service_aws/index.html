<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Personal Notifications Using AWS</title><link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.min.css"><link rel="stylesheet" href="/index.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark.min.css" media="screen and (prefers-color-scheme: dark)"></head><body><header><nav class="flex flex-row items-center justify-between"><a href="/" class="link nav-brand no-underline dtc w-25 f3">Wiwa</a><div class="dtc v-mid w-75 tr"><a href="/blog" class="link nav-link f6 f5-ns dib mr3 mr4-ns b">Blog</a><a href="/projects" class="link nav-link f6 f5-ns dib mr3 mr4-ns ">Projects</a></div></nav></header><main class="pt-4"><div><article><h1 class="f2">Personal Notifications Using AWS</h1><time class="db mb1">2022-02-11</time><div><p>I've found quite a few uses for recurring and scheduled scripts in my personal life. In days gone by I would have run these in a cron job on a server somewhere but as I've gotten into the weeds of AWS infrastructure I've leant on some AWS services more for these little personal conveniences. My preference nowadays is to use AWS Lambda as my first point of call and integrate other services as I need them. I'm very confident that AWS won't be deprecating their Lambda platform and they connect well to Cloudwatch, meaning I don't have to worry about creating a logging solution. Additionally now that I'm pretty confident with the AWS CDK for spinning up infrastructure it's a breeze to connect other services to assist with any other needs. Today I'll go through one example which provided a flexible and <strong>cheap</strong> solution to my problem.</p>
<!--more-->
<p>It can be quite difficult to find a good sports massage service and I've recently been very lucky to find a fantastic one. Of course they are booked out months in advance, which doesn't bother me too much but sometimes after a big training session I'll need something worked on sooner rather than later. Appointments do pop up from time to time due to cancellations but I didn't really want to keep checking their website throughout the day. So it made sense to automate the process somewhat.</p>
<p>Firstly the code for the lambda. Fairly easy to test locally (minus the SNS dispatch), I've abridged a few things here but you get the idea. Basically it performs a GET request to the API endpoint for appointments available, if the response array has anything in it send an SMS message to all subscribers.</p>
<pre><code class="language-ts hljs language-typescript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DateTime</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"luxon"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PublishCommand</span>, SNSClient } <span class="hljs-keyword">from</span> <span class="hljs-string">"@aws-sdk/client-sns"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">URL</span>, URLSearchParams } <span class="hljs-keyword">from</span> <span class="hljs-string">"url"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EventBridgeHandler</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"aws-lambda"</span>;

<span class="hljs-keyword">interface</span> MonthYearProps {
  <span class="hljs-attr">month</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">year</span>: <span class="hljs-built_in">number</span>;
  days?: <span class="hljs-built_in">number</span>[];
}

<span class="hljs-keyword">interface</span> ResponseAppointment {
  <span class="hljs-attr">day</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">day_parts</span>: <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span>;
}

<span class="hljs-keyword">const</span> region = process.<span class="hljs-property">env</span>.<span class="hljs-property">AWS_REGION</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">TopicArn</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">TOPIC_ARN</span>;
<span class="hljs-keyword">const</span> apiEndpointUrl = process.<span class="hljs-property">env</span>.<span class="hljs-property">API_ENDPOINT_URL</span>

<span class="hljs-keyword">const</span> nextMonths = <span class="hljs-title class_">Array</span>(<span class="hljs-number">2</span>)
  .<span class="hljs-title function_">fill</span>(<span class="hljs-title class_">DateTime</span>.<span class="hljs-title function_">now</span>().<span class="hljs-title function_">setZone</span>(<span class="hljs-string">"Australia/Canberra"</span>))
  .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">date: DateTime, index</span>) =&gt;</span> date.<span class="hljs-title function_">plus</span>({ <span class="hljs-attr">months</span>: index }));

<span class="hljs-keyword">const</span> <span class="hljs-title function_">apiEndpoint</span> = (<span class="hljs-params">{ month, year }: MonthYearProps</span>) =&gt; {
  <span class="hljs-keyword">const</span> endpoint = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(apiEndpointUrl);
  <span class="hljs-keyword">const</span> searchParams = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URLSearchParams</span>({
    <span class="hljs-attr">month</span>: month.<span class="hljs-title function_">toString</span>(),
    <span class="hljs-attr">year</span>: year.<span class="hljs-title function_">toString</span>(),
  });
  endpoint.<span class="hljs-property">search</span> = searchParams.<span class="hljs-title function_">toString</span>();

  <span class="hljs-keyword">return</span> endpoint.<span class="hljs-property">href</span>;
};

<span class="hljs-keyword">const</span> sendNotification = <span class="hljs-keyword">async</span> ({ month, year, days }: <span class="hljs-title class_">MonthYearProps</span>) =&gt; {
  <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title function_">SNSClient</span>({ region });
  <span class="hljs-keyword">const</span> dates = days.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">day</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${day}</span>/<span class="hljs-subst">${month}</span>/<span class="hljs-subst">${year}</span>`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">", "</span>);
  <span class="hljs-keyword">const</span> message = <span class="hljs-string">`Appointments available: <span class="hljs-subst">${dates}</span>`</span>;
  <span class="hljs-keyword">const</span> command = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PublishCommand</span>({
    <span class="hljs-title class_">Subject</span>: <span class="hljs-string">"Appointments available"</span>,
    <span class="hljs-title class_">Message</span>: message,
    <span class="hljs-title class_">TopicArn</span>,
  });
  <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">send</span>(command);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">handler</span>: <span class="hljs-title class_">EventBridgeHandler</span>&lt;<span class="hljs-built_in">string</span>, unknown, <span class="hljs-built_in">void</span>&gt; = <span class="hljs-function">() =&gt;</span> {
  nextMonths.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">async</span> ({ month, year }) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { data }: { <span class="hljs-attr">data</span>: <span class="hljs-title class_">ResponseAppointment</span>[] } = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(
        <span class="hljs-title function_">apiEndpoint</span>({ month, year })
      );
      <span class="hljs-keyword">if</span> (data.<span class="hljs-property">length</span> !== <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> days = data.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">{ day }</span>) =&gt;</span> day);
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendNotification</span>({ month, year, days });
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`No appointments found on <span class="hljs-subst">${month}</span>/<span class="hljs-subst">${year}</span>`</span>);
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
  });
};
</code></pre>
<p>Now let's build the infrastructure around it. I've pretty much standardised on AWS CDK for deployment since it does a great job of holding your hand and creating a lot of the interlinking IAM permissions for you. There's only a few things going on here.</p>
<ol>
<li>Create an SNS topic.</li>
<li>Create a lambda function and point it to the above code, we need to wait for the SNS topic to finish being created since we're sending the SNS topic ARN to the lambda function in the form of an environment variable.</li>
<li>Grant permissions using the convenience method <code>grantPublish</code>.</li>
<li>Subscribe any emails (mine) to the topic.</li>
<li>Schedule the lambda on a recurring basis. I chose once every hour during business hours to not spam either my own email or the booking website.</li>
</ol>
<pre><code class="language-ts hljs language-typescript"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Stack</span>,
  <span class="hljs-title class_">StackProps</span>,
  aws_sns <span class="hljs-keyword">as</span> sns,
  aws_lambda <span class="hljs-keyword">as</span> lambda,
  aws_logs <span class="hljs-keyword">as</span> logs,
  aws_sns_subscriptions <span class="hljs-keyword">as</span> subscriptions,
  aws_events <span class="hljs-keyword">as</span> events,
  aws_events_targets <span class="hljs-keyword">as</span> targets,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"aws-cdk-lib"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodejsFunction</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"aws-cdk-lib/aws-lambda-nodejs"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Construct</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"constructs"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InfraStack</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Stack</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">scope: Construct, id: <span class="hljs-built_in">string</span>, props?: StackProps</span>) {
    <span class="hljs-variable language_">super</span>(scope, id, props);

    <span class="hljs-keyword">const</span> emails = process.<span class="hljs-property">env</span>.<span class="hljs-property">EMAILS</span>?.<span class="hljs-title function_">split</span>(<span class="hljs-string">","</span>) ?? [];

    <span class="hljs-keyword">const</span> topic = <span class="hljs-keyword">new</span> sns.<span class="hljs-title class_">Topic</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">"WiwaNotificationsTopic"</span>, {
      <span class="hljs-attr">displayName</span>: <span class="hljs-string">"Available Appointments"</span>,
    });

    <span class="hljs-keyword">const</span> fn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodejsFunction</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">"WiwaNotificationsLambda"</span>, {
      <span class="hljs-attr">entry</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">".."</span>, <span class="hljs-string">".."</span>, <span class="hljs-string">"src"</span>, <span class="hljs-string">"index.ts"</span>),
      <span class="hljs-attr">description</span>: <span class="hljs-string">"Check booking site for open appointments"</span>,
      <span class="hljs-attr">environment</span>: {
        <span class="hljs-attr">TOPIC_ARN</span>: topic.<span class="hljs-property">topicArn</span>,
      },
      <span class="hljs-attr">runtime</span>: lambda.<span class="hljs-property">Runtime</span>.<span class="hljs-property">NODEJS_14_X</span>,
      <span class="hljs-attr">logRetention</span>: logs.<span class="hljs-property">RetentionDays</span>.<span class="hljs-property">ONE_WEEK</span>,
    });

    fn.<span class="hljs-property">node</span>.<span class="hljs-title function_">addDependency</span>(topic);
    topic.<span class="hljs-title function_">grantPublish</span>(fn);

    emails.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">email</span>) =&gt;</span> {
      topic.<span class="hljs-title function_">addSubscription</span>(<span class="hljs-keyword">new</span> subscriptions.<span class="hljs-title class_">EmailSubscription</span>(email));
    });

    <span class="hljs-keyword">const</span> rule = <span class="hljs-keyword">new</span> events.<span class="hljs-title class_">Rule</span>(
      <span class="hljs-variable language_">this</span>,
      <span class="hljs-string">"WiwaNotificationsScheduleRule"</span>,
      {
        <span class="hljs-attr">schedule</span>: events.<span class="hljs-property">Schedule</span>.<span class="hljs-title function_">cron</span>({ <span class="hljs-attr">minute</span>: <span class="hljs-string">"24"</span>, <span class="hljs-attr">hour</span>: <span class="hljs-string">"0-8,20-23"</span> }),
        <span class="hljs-attr">description</span>: <span class="hljs-string">"Check every hour during the day"</span>,
      }
    );
    rule.<span class="hljs-title function_">addTarget</span>(<span class="hljs-keyword">new</span> targets.<span class="hljs-title class_">LambdaFunction</span>(fn));
  }
}
</code></pre>
<p>And that's it! This now sends me open bookings which probably pop up once or twice a week. It's a nice little piece of functionality which lives well within the free tier limits of AWS.</p>
</div></article></div></main></body></html>